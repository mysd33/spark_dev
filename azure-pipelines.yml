# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  IVY_CACHE_FOLDER: $(Pipeline.Workspace)/.ivy2/
  SBT_IVY_OPTION: "--ivy $(IVY_CACHE_FOLDER)"

steps:
- task: Cache@2
  inputs:
    key: 'sbt | "$(Agent.OS)" | **/build.sbt'
    restoreKeys: |
      sbt | "$(Agent.OS)
      sbt
    path: $(IVY_CACHE_FOLDER)
  displayName: sbt build cache

- script: |
    echo build
    sbt $(SBT_IVY_OPTION) clean package
  displayName: Build

- script: |
    echo scaladoc
    sbt $(SBT_IVY_OPTION) doc
  displayName: Create API Document

- script: |
    echo test
    sbt $(SBT_IVY_OPTION) -Dactive.profile=ut jacocoAggregate
  displayName: Unit Test

##https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-test-results?view=azure-devops
- task: PublishTestResults@2

## https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/test/publish-code-coverage-results?view=azure-devops
- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: "JaCoCo"
    summaryFileLocation: "$(System.DefaultWorkingDirectory)/target/**/jacoco/report/aggregate/jacoco.xml"
    reportDirectory: "$(System.DefaultWorkingDirectory)/target/**/jacoco/report/aggregate/html"
    additionalCodeCoverageFiles: "$(System.DefaultWorkingDirectory)/target/**/jacoco/data/jacoco.exec, $(System.DefaultWorkingDirectory)/target/**/jacoco/report/aggregate/html/jacoco-resources/*.gif"
  displayName: Publish Code Coverage Results

- script: |
    echo assembly
    sbt $(SBT_IVY_OPTION) assembly
  displayName: Create Assembly